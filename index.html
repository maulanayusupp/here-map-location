<!DOCTYPE html>
<html>
<title>Here Map Location</title>
<head>
  <meta name="viewport" content="initial-scale=1.0, width=device-width" />

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

  <link rel="stylesheet" type="text/css" href="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.css" />
  <script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-core.js"></script>
  <script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-service.js"></script>
  <script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-ui.js"></script>
  <script type="text/javascript" src="https://js.cit.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
  <style type="text/css">
    .info-container {
      min-width: 500px !important;
      max-width: 700px !important;
    }
    .pull-left,
    .pull-right {
      display: inline-block !important;
    }
  </style>
</head>
<body>
  <div class="btn btn-primary btn-block" id="drop-in">Drop In</div>
  <div id="map" style="width: 100%; height: 400px; background: grey" />
  <script  type="text/javascript" charset="UTF-8" >
    // drop in marker
    function btnDropInClicked () {
      window.onload = function(){
        document.getElementById("drop-in").addEventListener("click", myFunction);

        function myFunction() {
          // Add the click event listener.
          var lat=-6.864856, lng=107.579930;
          addDraggableMarker(map, behavior, lat, lng);
        }
      };
    };

    /**
     * Adds a  draggable marker to the map..
     *
     * @param {H.Map} map                      A HERE Map instance within the
     *                                         application
     * @param {H.mapevents.Behavior} behavior  Behavior implements
     *                                         default interactions for pan/zoom
     */
    function addDraggableMarker(map, behavior, lat, lng){
      var dragged = false;
      // Create a group that can hold map objects:
      var group = new H.map.Group();

      // Add the group to the map object (created earlier):
      map.addObject(group);

      /*// add 'tap' event listener, that opens info bubble, to the group
      group.addEventListener('tap', function (evt) {
        // event target is the marker itself, group is a parent event target
        // for all objects that it contains
        var bubble =  new H.ui.InfoBubble(evt.target.getPosition(), {
          // read custom data
          content: evt.target.getData()
        });
        // show info bubble
        ui.addBubble(bubble);
      }, false);*/

      var html = `
                    <div class="info-container clearfix">
                      <div class="pull-left">
                        <a href=\'http://pixelhouse.id/\' target="blank">
                          <div class="btn btn-warning">Pixel House Studio</div>
                        </a>
                      </div>
                      <div class="pull-right">
                        <a href=\'http://managix.id/\' target="blank">
                          <div class="btn btn-primary">Managix</div>
                        </a>
                      </div>
                    </div>
                    <div>
                      Jl. Gegerkalong Tonggoh III No.15, Gegerkalong, Sukasari, Kota Bandung, Jawa Barat 40153, Indonesia
                    </div>
                  `;

      // create marker
      var marker = new H.map.Marker({lat:lat, lng:lng});
      // Ensure that the marker can receive drag events
      marker.draggable = true;
      marker.setData(html);
      group.addObject(marker);

      // create area in marker
      var area = new H.map.Circle(
        // The central point of the circle
        {lat:lat, lng:lng},
        // The radius of the circle in meters
        1000,
        {
          style: {
            strokeColor: 'rgba(55, 85, 170, 0.6)', // Color of the perimeter
            lineWidth: 1,
            fillColor: 'rgba(8, 138, 254, 0.43)'  // Color of the circle
          }
        }
      );
      group.addObject(area);

      // disable the default draggability of the underlying map
      // when starting to drag a marker object:
      group.addEventListener('dragstart', function(ev) {
        dragged = true;
        var target = ev.target;
        var coord = map.screenToGeo(ev.currentPointer.viewportX, ev.currentPointer.viewportY);

        console.log("start")
        group.removeObject(area);
        if (target instanceof H.map.Marker) {
          behavior.disable();
        }
      }, false);


      // re-enable the default draggability of the underlying map
      // when dragging has completed
      group.addEventListener('dragend', function(ev) {
        var target = ev.target;
        console.log("dragged")

        var coord = map.screenToGeo(ev.currentPointer.viewportX, ev.currentPointer.viewportY);
        console.log(coord)

        if (dragged) {
          area = new H.map.Circle(
            // The central point of the circle
            {lat:coord.lat, lng:coord.lng},
            // The radius of the circle in meters
            1000,
            {
              style: {
                strokeColor: 'rgba(55, 85, 170, 0.6)', // Color of the perimeter
                lineWidth: 1,
                fillColor: 'rgba(8, 138, 254, 0.43)'  // Color of the circle
              }
            }
          );
          group.addObject(area);
        }
        dragged = false;


        if (target instanceof mapsjs.map.Marker) {
          behavior.enable();
        }
      }, false);

      // Listen to the drag event and move the position of the marker
      // as necessary
       group.addEventListener('drag', function(ev) {
        var target = ev.target,
            pointer = ev.currentPointer;

        /*console.log("X: " + pointer.viewportX)
        console.log("Y: " + pointer.viewportY)*/

        // var coord = map.screenToGeo(ev.currentPointer.viewportX, ev.currentPointer.viewportY);
        // console.log(coord)
        if (target instanceof mapsjs.map.Marker) {
          target.setPosition(map.screenToGeo(pointer.viewportX, pointer.viewportY));
        }
      }, false);
    }

    /**
     * An event listener is added to listen to tap events on the map.
     * Clicking on the map displays an alert box containing the latitude and longitude
     * of the location pressed.
     * @param  {H.Map} map      A HERE Map instance within the application
     */
    function setUpClickListener(map) {
      // Attach an event listener to map display
      // obtain the coordinates and display in an alert box.
      map.addEventListener('tap', function (evt) {
        var coord = map.screenToGeo(evt.currentPointer.viewportX, evt.currentPointer.viewportY);
        // addDraggableMarker(map, behavior, coord.lat, coord.lng);
        // console.log(coord)
      });
    }

    /**
     * Boilerplate map initialization code starts below:
     */
    //Step 1: initialize communication with the platform
    var platform = new H.service.Platform({
      app_id: 'DemoAppId01082013GAL',
      app_code: 'AJKnXv84fjrb0KIHawS0Tg',
      useCIT: true,
      useHTTPS: true
    });
    var defaultLayers = platform.createDefaultLayers();

    //Step 2: initialize a map - this map is centered
    var map = new H.Map(document.getElementById('map'),
      defaultLayers.normal.map,{
      center: {lat:-6.864856, lng:107.579930},
      zoom: 13
    });

    //Step 3: make the map interactive
    // MapEvents enables the event system
    // Behavior implements default interactions for pan/zoom (also on mobile touch environments)
    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

    // Step 4: Create the default UI:
    var ui = H.ui.UI.createDefault(map, defaultLayers, 'en-US');

    /* setup click listener */
    setUpClickListener(map);
    btnDropInClicked();
  </script>
</body>
</html>